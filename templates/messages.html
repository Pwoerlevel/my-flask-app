{% extends "base.html" %}

{% block title %}{{ user.username }} - Ø§Ù„Ø±Ø³Ø§Ø¦Ù„{% endblock %}

{% block content %}

<style>
    /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
.messages-container {
    max-width: 600px;
    margin: 20px auto;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 10px;
    background-color: #f9f9f9;
    font-family: Arial, sans-serif;
}

/* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
.user-info {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    background-color: #ffffff;
    border-bottom: 1px solid #ddd;
}

.profile-photo {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-right: 10px;
}

.username {
    font-size: 18px;
    font-weight: bold;
}

/* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
.messages-list {
    display: flex;
    flex-direction: column;
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
    background-color: #ffffff;
    border-radius: 5px;
    margin-bottom: 15px;
}

/* Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
.message-item {
    margin: 5px 0;
    padding: 10px;
    border-radius: 15px;
    max-width: 75%;
    word-wrap: break-word;
    font-size: 14px;
}

/* Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„Ø© */
.message-item.sent {
    background-color: #0078ff;
    color: #ffffff;
    align-self: flex-end;
    text-align: right;
}

/* Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© */
.message-item.received {
    background-color: #f1f0f0;
    color: #000000;
    align-self: flex-start;
    text-align: left;
}

/* Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ */
.message-timestamp {
    font-size: 10px;
    color: #666;
    margin-top: 5px;
    display: block;
}

/* Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
.message-input {
    /* display: flex; */
    align-items: center;
    gap: 10px;
}

textarea#message-input {
    width: 100%;
    height: 50px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    resize: none;
    font-size: 14px;
}

button#send-message-btn {
    background-color: #0078ff;
    color: #ffffff;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s;
}

button#send-message-btn:hover {
    background-color: #005bb5;
}

 .received .seen-status{
    display: none;
}
img{
    max-width: 100%;
}

video{
    max-width: 100%;
}

.input-group{
    display: flex;
    flex-direction: row-reverse;
    align-items: center;
    position: fixed;
    bottom: 10px;
    width: calc(100vw - 16.8px);
}


.file-upload-btn{
    font-size: 25px;
    margin-top: 5px;
}

/* Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
.loading-circle {
    display: inline-block;
    width: 40px;  /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø¬Ù… Ù„ÙŠÙƒÙˆÙ† Ø£ÙƒØ«Ø± ÙˆØ¶ÙˆØ­Ù‹Ø§ */
    height: 40px;
    border: 4px solid #0078ff;  /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø²Ø§Ù‡ÙŠ */
    border-top: 4px solid transparent;  /* Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø´ÙØ§Ù Ù„Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¯ÙˆØ§Ø± */
    border-radius: 50%;  /* Ø¬Ø¹Ù„Ù‡Ø§ Ø¯Ø§Ø¦Ø±ÙŠØ© */
    animation: spin 0.8s linear infinite;  /* Ø³Ø±Ø¹Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ± Ø£ØµØ¨Ø­Øª Ø£Ø³Ø±Ø¹ (0.8 Ø«Ø§Ù†ÙŠØ©) */
    margin: 10px auto;  /* Ø¶Ø¨Ø· Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    box-shadow: 0px 0px 10px rgba(0, 120, 255, 0.5);  /* Ø¥Ø¶Ø§ÙØ© Ø¸Ù„ Ø®ÙÙŠÙ Ù„Ø¥Ø¹Ø·Ø§Ø¡ ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¹Ù…Ù‚ */
}

/* Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø°ÙŠ ÙŠØ¬Ø¹Ù„ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© ØªØ¯ÙˆØ± */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}



/* ØªÙ†Ø³ÙŠÙ‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    position: relative;
    max-width: 90%;
    max-height: 90%;
    margin-left: auto;
    top: 50%;
    margin-right: auto;
    transform: translate(0, -50%);
}

#closeModal {
    position: absolute;
    top: 10px;
    right: 10px;
    background: red;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    cursor: pointer;
}

.send-button {
    background: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 10px;
}

.send-button:hover {
    background: #0056b3;
}

#file-preview img,
#file-preview video {
    max-width: 100px;
    max-height: 100px;
    border-radius: 5px;
    margin-top: 10px;
}


/* ØªÙ†Ø³ÙŠÙ‚ Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
.loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 10px;
    font-size: 14px;
    color: #007bff;
    background-color: #f1f1f1;
    border-radius: 5px;
    margin: 10px auto;
    width: fit-content;
}

.loading-spinner::before {
    content: "";
    border: 3px solid #f3f3f3;
    border-top: 3px solid #007bff;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
    margin-right: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
.loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
    background-color: #f1f1f1;
    border-radius: 5px;
    margin: 10px auto;
    width: fit-content;
}

.loading-spinner {
    font-size: 14px;
    color: #007bff;
    margin-bottom: 10px;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
.progress-bar {
    width: 200px;
    height: 10px;
    background-color: #e0e0e0;
    border-radius: 5px;
    overflow: hidden;
}

.progress {
    height: 100%;
    background-color: #007bff;
    width: 0%;
    transition: width 0.3s ease;
}
</style>
<div class="messages-container">
    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
    <div class="user-info">
        <img src="{{ url_for('static', filename=user.profile_photo) }}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" class="profile-photo">
        <span class="username">{{ user.username }}</span>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
    <div class="messages-list" id="messages-list">
        <div id="loading-container" style="display: none;">
            <div class="loading-circle"></div>
        </div>
    </div>

    <!-- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
    <div class="message-input">
        <form id="messageForm" enctype="multipart/form-data">
            <div class="input-group">
                <label for="file-input" class="file-upload-btn">
                    ğŸ“
                    <input type="file" id="file-input" name="file" accept="image/*, video/*" hidden>
                </label>
                <textarea id="message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."></textarea>
               
                <button type="submit" id="send-message-btn">Ø§Ø±Ø³Ø§Ù„</button>
            </div>
            <div id="file-preview"></div>
        </form>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
<div id="previewModal" class="modal">
    <div class="modal-content">
        <button id="closeModal">&times;</button>
        <div id="modalPreview"></div>
        <button id="sendFromModal" class="send-button">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
</div>

<script>
$(document).ready(async function () {
    const messageList = $('#messages-list');
    const receiverId = {{ user.id }};
    let selectedFile = null;

    // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ "Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©"
    await fetch('/join_chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    });

    // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¥Ù„Ù‰ "Ù…Ù‚Ø±ÙˆØ¡Ø©" Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    await fetch('/mark_all_as_seen', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ receiver_id: receiverId }),
    });

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù
    $('#file-input').change(function(e) {
        const file = e.target.files[0];
        if (file) {
            selectedFile = file;
            showFilePreview(file);
        }
    });

    function showFilePreview(file) {
        const preview = $('#file-preview');
        preview.empty();

        if (file.type.startsWith('image/')) {
            preview.append(`<img src="${URL.createObjectURL(file)}" class="preview-image">`);
        } else if (file.type.startsWith('video/')) {
            preview.append(`
                <video controls class="preview-video">
                    <source src="${URL.createObjectURL(file)}" type="${file.type}">
                </video>
            `);
        }

        preview.append(`
            <div class="file-info">
                <span>${file.name}</span>
                <button type="button" class="remove-file-btn">Ã—</button>
            </div>
        `);

        $('.remove-file-btn').click(() => {
            selectedFile = null;
            preview.empty();
            $('#file-input').val('');
        });
    }
    async function loadMessages() {
    try {
        const response = await fetch(`/get_messages/${receiverId}`);
        const messages = await response.json();

        if (!Array.isArray(messages)) {
            console.error('Ø§Ù„Ø±Ø¯ Ù„ÙŠØ³ Ù…ØµÙÙˆÙØ©:', messages);
            return;
        }

        messageList.empty();
        messages.forEach(message => {
            const messageItem = $('<div>')
                .addClass('message-item')
                .attr('data-message-id', message.id);

            // ØªØ­Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø±Ø³Ù„Ø© Ø£Ùˆ Ù…Ø³ØªÙ‚Ø¨Ù„Ø©
            if (message.sender_id === {{ current_user.id }}) {
                messageItem.addClass('sent');

                // Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ù„Ù„Ù…Ø±Ø³Ù„
                if (message.watched_by_receiver) {
                    messageItem.append('<span class="seen-status">âœ“âœ“</span>');  // Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                } else {
                    messageItem.append('<span class="seen-status">âœ“</span>');   // Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø±Ø³Ù„Ø©ØŒ ÙˆÙ„ÙƒÙ† Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ù„Ù… ÙŠØ´Ø§Ù‡Ø¯Ù‡Ø§ Ø¨Ø¹Ø¯
                }
            } else {
                messageItem.addClass('received');
                // Ù„Ø§ ØªØ¸Ù‡Ø± Ø£ÙŠ Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
            }

            const contentContainer = $('<div>').addClass('message-content');

            // Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· (ØµÙˆØ± Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª) Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (message.file_url) {
                if (message.file_type.startsWith('image/')) {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØµÙˆØ±Ø©
                    contentContainer.append(`<img src="/${message.file_url}" class="message-media">`);
                } else if (message.file_type.startsWith('video/')) {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠØ¯ÙŠÙˆ
                    contentContainer.append(`
                        <video controls class="message-media">
                            <source src="/${message.file_url}" type="${message.file_type}">
                        </video>
                    `);
                }
            }

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ØµÙˆØµ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (message.content) {
                contentContainer.append(`<span>${message.content}</span>`);
            }

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ
            const timestamp = $('<span>')
                .addClass('message-timestamp')
                .text(message.created_at);

            // Ø¥Ø¶Ø§ÙØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            messageItem.append(contentContainer).append(timestamp);
            messageList.append(messageItem);
        });

        // ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø³ÙÙ„ Ù„Ø±Ø¤ÙŠØ© Ø¢Ø®Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        messageList.scrollTop(messageList.prop('scrollHeight'));
    } catch (error) {
        console.error('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:', error);
    }
}



    // SSE Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
    const updateEventSource = new EventSource(`/stream_message_updates/${receiverId}`);
    updateEventSource.onmessage = function (event) {
        const data = JSON.parse(event.data);
        const messageId = data.message_id;
        const isSender = data.sender_id === {{ current_user.id }};

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ Ø§Ù„Ù…Ø±Ø³Ù„
        if (isSender) {
            const seenStatus = $(`.message-item[data-message-id="${messageId}"] .seen-status`);
            if (data.watched_by_receiver) {
                seenStatus.text('âœ“âœ“'); // Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            } else {
                seenStatus.text('âœ“'); // Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø±Ø³Ù„Ø©ØŒ ÙˆÙ„ÙƒÙ† Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ù„Ù… ÙŠØ´Ø§Ù‡Ø¯Ù‡Ø§ Ø¨Ø¹Ø¯
            }
        }
    };

    updateEventSource.onerror = function () {
        console.log('SSE error. Reconnecting...');
        setTimeout(() => {
            new EventSource(`/stream_message_updates/${receiverId}`);
        }, 3000);
    };

    // SSE Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const eventSource = new EventSource(`/stream_messages/${receiverId}`);
    eventSource.onmessage = function (event) {
        loadMessages();
    };

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©


// Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù

// Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù
$('#file-input').change(function(e) {
    const file = e.target.files[0];
    if (file) {
        selectedFile = file;
        showFilePreview(file); // Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„Ù
    }
});

// Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„Ù ÙÙŠ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©
function showFilePreview(file) {
    const previewModal = $('#previewModal');
    const modalPreview = $('#modalPreview');

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚
    modalPreview.empty();

    if (file.type.startsWith('image')) {
        // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©
        const img = $('<img>').attr('src', URL.createObjectURL(file)).css({ maxWidth: '100%', maxHeight: '80vh' });
        modalPreview.append(img);
    } else if (file.type.startsWith('video')) {
        // Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        const video = $('<video>').attr('src', URL.createObjectURL(file)).attr('controls', true).css({ maxWidth: '100%', maxHeight: '80vh' });
        modalPreview.append(video);
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    previewModal.show();
}

// Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
$('#closeModal').click(function() {
    $('#previewModal').hide();
});

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
$('#sendFromModal').click(function() {
    $('#previewModal').hide();
    $('#messageForm').submit();
});

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
$('#messageForm').submit(async function(e) {
    e.preventDefault();
    const messageContent = $('#message-input').val().trim();
    const formData = new FormData();
    formData.append('content', messageContent);
    formData.append('receiver_id', receiverId);

    if (selectedFile) {
        formData.append('file', selectedFile);

        // Ø¥Ø¸Ù‡Ø§Ø± Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… ÙÙŠ Ù…ÙƒØ§Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        $('#messages-list').append(`
            <div class="loading-container">
                <div class="loading-spinner">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                <div class="progress-bar">
                    <div class="progress"></div>
                </div>
            </div>
        `);
    }

    if (!messageContent && !selectedFile) return;

    try {
        const isReceiverActive = await fetch(`/is_user_active/${receiverId}`).then(res => res.json());

        // Ø§Ø³ØªØ®Ø¯Ø§Ù… XMLHttpRequest Ù„ØªØªØ¨Ø¹ ØªÙ‚Ø¯Ù… Ø§Ù„Ø±ÙØ¹
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/send_message', true);

        // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹
        xhr.upload.onprogress = function(event) {
            if (event.lengthComputable) {
                const percentComplete = (event.loaded / event.total) * 100;
                $('.progress').css('width', percentComplete + '%');
            }
        };

        xhr.onload = function() {
            if (xhr.status === 200) {
                $('#message-input').val('');
                $('#file-preview').empty();
                selectedFile = null;
                $('#file-input').val('');

                if (isReceiverActive.active) {
                    const messageId = JSON.parse(xhr.responseText).message_id;
                    fetch(`/mark_message_as_seen/${messageId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    });
                }

                // Ø¥Ø®ÙØ§Ø¡ Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                $('.loading-container').remove();
                loadMessages();
            } else {
                console.error('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', xhr.statusText);
                $('.loading-container').remove();
            }
        };

        xhr.onerror = function() {
            console.error('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', xhr.statusText);
            $('.loading-container').remove();
        };

        xhr.send(formData);
    } catch (error) {
        console.error('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
        // Ø¥Ø®ÙØ§Ø¡ Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… ÙÙŠ Ø­Ø§Ù„Ø© Ø­Ø¯ÙˆØ« Ø®Ø·Ø£
        $('.loading-container').remove();
    }
});


    await loadMessages();
});

window.addEventListener('beforeunload', async function () {
    await fetch('/leave_chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    });

    if (updateEventSource) updateEventSource.close();
    if (eventSource) eventSource.close();
});
</script>


{% endblock %}